#!/usr/bin/env python3
"""
ì„±ëŠ¥ ìµœì í™” ë° ë©”ëª¨ë¦¬ ê´€ë¦¬ ê¸°ëŠ¥ ë°ëª¨

ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¤ìŒ ê¸°ëŠ¥ë“¤ì„ ì‹œì—°í•©ë‹ˆë‹¤:
1. ê¸´ê¸‰ë„ ê³„ì‚° ìºì‹±
2. ë°°ì¹˜ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
3. ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìµœì í™”
4. ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
"""

import sys
import os
import time
import threading
from datetime import datetime, timedelta

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ Python ê²½ë¡œì— ì¶”ê°€
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from utils.performance_utils import (
    PerformanceOptimizer, UrgencyCache, BatchUpdateManager, 
    RealTimeUpdateOptimizer, MemoryMonitor, get_performance_optimizer
)
from services.date_service import DateService


def demo_urgency_cache():
    """ê¸´ê¸‰ë„ ê³„ì‚° ìºì‹± ë°ëª¨"""
    print("=== ê¸´ê¸‰ë„ ê³„ì‚° ìºì‹± ë°ëª¨ ===")
    
    cache = UrgencyCache(max_size=100, ttl_seconds=30)
    
    # í…ŒìŠ¤íŠ¸ ë‚ ì§œë“¤
    test_dates = [
        datetime.now() + timedelta(hours=1),    # 1ì‹œê°„ í›„ (urgent)
        datetime.now() + timedelta(days=1),     # 1ì¼ í›„ (warning)
        datetime.now() + timedelta(days=5),     # 5ì¼ í›„ (normal)
        datetime.now() - timedelta(hours=2),    # 2ì‹œê°„ ì „ (overdue)
        None                                    # ëª©í‘œ ë‚ ì§œ ì—†ìŒ (normal)
    ]
    
    print("ì²« ë²ˆì§¸ ê³„ì‚° (ìºì‹œ ë¯¸ìŠ¤):")
    start_time = time.time()
    for i, due_date in enumerate(test_dates):
        urgency = DateService.get_urgency_level(due_date)
        print(f"  ë‚ ì§œ {i+1}: {urgency}")
    first_time = time.time() - start_time
    
    print(f"\në‘ ë²ˆì§¸ ê³„ì‚° (ìºì‹œ íˆíŠ¸):")
    start_time = time.time()
    for i, due_date in enumerate(test_dates):
        urgency = DateService.get_urgency_level(due_date)
        print(f"  ë‚ ì§œ {i+1}: {urgency}")
    second_time = time.time() - start_time
    
    print(f"\nì„±ëŠ¥ ê°œì„ :")
    print(f"  ì²« ë²ˆì§¸: {first_time:.4f}ì´ˆ")
    print(f"  ë‘ ë²ˆì§¸: {second_time:.4f}ì´ˆ")
    print(f"  ê°œì„ ìœ¨: {((first_time - second_time) / first_time * 100):.1f}%")
    
    # ìºì‹œ í†µê³„
    stats = cache.get_stats()
    print(f"\nìºì‹œ í†µê³„:")
    print(f"  í¬ê¸°: {stats['size']}/{stats['max_size']}")
    print(f"  TTL: {stats['ttl_seconds']}ì´ˆ")


def demo_batch_update():
    """ë°°ì¹˜ ì—…ë°ì´íŠ¸ ë°ëª¨"""
    print("\n=== ë°°ì¹˜ ì—…ë°ì´íŠ¸ ë°ëª¨ ===")
    
    batch_manager = BatchUpdateManager(batch_size=5, flush_interval=2.0)
    
    # ì—…ë°ì´íŠ¸ ì²˜ë¦¬ í•¨ìˆ˜
    def process_todo_updates(updates):
        print(f"ë°°ì¹˜ ì²˜ë¦¬: {len(updates)}ê°œ í• ì¼ ì—…ë°ì´íŠ¸")
        for update in updates:
            print(f"  - í• ì¼ {update['item_id']}: {update['data']}")
    
    def process_subtask_updates(updates):
        print(f"ë°°ì¹˜ ì²˜ë¦¬: {len(updates)}ê°œ í•˜ìœ„ì‘ì—… ì—…ë°ì´íŠ¸")
        for update in updates:
            print(f"  - í•˜ìœ„ì‘ì—… {update['item_id']}: {update['data']}")
    
    # ì½œë°± ë“±ë¡
    batch_manager.register_update_callback('todo_update', process_todo_updates)
    batch_manager.register_update_callback('subtask_update', process_subtask_updates)
    
    print("ê°œë³„ ì—…ë°ì´íŠ¸ ìš”ì²­ (ë°°ì¹˜ë¡œ ì²˜ë¦¬ë¨):")
    
    # í• ì¼ ì—…ë°ì´íŠ¸ ìš”ì²­
    for i in range(3):
        batch_manager.queue_update('todo_update', i+1, {'title': f'í• ì¼ {i+1} ìˆ˜ì •'})
        print(f"  í• ì¼ {i+1} ì—…ë°ì´íŠ¸ ìš”ì²­")
        time.sleep(0.1)
    
    # í•˜ìœ„ì‘ì—… ì—…ë°ì´íŠ¸ ìš”ì²­
    for i in range(4):
        batch_manager.queue_update('subtask_update', i+1, {'completed': True})
        print(f"  í•˜ìœ„ì‘ì—… {i+1} ì—…ë°ì´íŠ¸ ìš”ì²­")
        time.sleep(0.1)
    
    print("\në°°ì¹˜ í¬ê¸° ë„ë‹¬ë¡œ ìë™ í”ŒëŸ¬ì‹œ ëŒ€ê¸°...")
    time.sleep(1)
    
    # ë‚¨ì€ ì—…ë°ì´íŠ¸ ê°•ì œ í”ŒëŸ¬ì‹œ
    print("\nê°•ì œ í”ŒëŸ¬ì‹œ:")
    batch_manager.force_flush()
    
    batch_manager.shutdown()


def demo_realtime_update():
    """ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìµœì í™” ë°ëª¨"""
    print("\n=== ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìµœì í™” ë°ëª¨ ===")
    
    optimizer = RealTimeUpdateOptimizer(update_interval=1.0, max_updates_per_second=5)
    
    # ì—…ë°ì´íŠ¸ ì¹´ìš´í„°
    update_counts = {'ui': 0, 'status': 0}
    
    def update_ui():
        update_counts['ui'] += 1
        print(f"UI ì—…ë°ì´íŠ¸ #{update_counts['ui']} - {datetime.now().strftime('%H:%M:%S.%f')[:-3]}")
    
    def update_status():
        update_counts['status'] += 1
        print(f"ìƒíƒœ ì—…ë°ì´íŠ¸ #{update_counts['status']} - {datetime.now().strftime('%H:%M:%S.%f')[:-3]}")
    
    # ì½œë°± ë“±ë¡
    optimizer.register_update_callback('ui', update_ui)
    optimizer.register_update_callback('status', update_status)
    
    print("ë¹ ë¥¸ ì—°ì† ì—…ë°ì´íŠ¸ ìš”ì²­ (ìµœì í™”ë¨):")
    
    # ë¹ ë¥¸ ì—°ì† ìš”ì²­ (ì´ˆë‹¹ ìµœëŒ€ 5íšŒë¡œ ì œí•œë¨)
    for i in range(20):
        optimizer.request_update('ui')
        optimizer.request_update('status')
        time.sleep(0.05)  # 50ms ê°„ê²©
    
    print("\nì—…ë°ì´íŠ¸ ì²˜ë¦¬ ëŒ€ê¸°...")
    time.sleep(3)
    
    print(f"\nê²°ê³¼:")
    print(f"  ìš”ì²­: 20íšŒ x 2 = 40íšŒ")
    print(f"  ì‹¤ì œ UI ì—…ë°ì´íŠ¸: {update_counts['ui']}íšŒ")
    print(f"  ì‹¤ì œ ìƒíƒœ ì—…ë°ì´íŠ¸: {update_counts['status']}íšŒ")
    print(f"  ìµœì í™”ìœ¨: {((40 - sum(update_counts.values())) / 40 * 100):.1f}%")
    
    optimizer.stop()


def demo_memory_monitor():
    """ë©”ëª¨ë¦¬ ëª¨ë‹ˆí„°ë§ ë°ëª¨"""
    print("\n=== ë©”ëª¨ë¦¬ ëª¨ë‹ˆí„°ë§ ë°ëª¨ ===")
    
    monitor = MemoryMonitor(warning_threshold=0.1, critical_threshold=0.2)  # ë‚®ì€ ì„ê³„ê°’ìœ¼ë¡œ í…ŒìŠ¤íŠ¸
    
    def on_warning(memory_info):
        print(f"âš ï¸  ë©”ëª¨ë¦¬ ê²½ê³ : {memory_info['usage_ratio']:.1%}")
        print(f"   ì‹œìŠ¤í…œ ë©”ëª¨ë¦¬: {memory_info['system_used'] / 1024**3:.1f}GB / {memory_info['system_total'] / 1024**3:.1f}GB")
    
    def on_critical(memory_info):
        print(f"ğŸš¨ ë©”ëª¨ë¦¬ ìœ„í—˜: {memory_info['usage_ratio']:.1%}")
        print(f"   ì¦‰ì‹œ ì •ë¦¬ ì‘ì—… í•„ìš”!")
    
    def on_normal(memory_info):
        print(f"âœ… ë©”ëª¨ë¦¬ ì •ìƒ: {memory_info['usage_ratio']:.1%}")
    
    # ì½œë°± ë“±ë¡
    monitor.register_callback('warning', on_warning)
    monitor.register_callback('critical', on_critical)
    monitor.register_callback('normal', on_normal)
    
    # í˜„ì¬ ë©”ëª¨ë¦¬ ì •ë³´
    memory_info = monitor.get_memory_info()
    print(f"í˜„ì¬ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: {memory_info['usage_ratio']:.1%}")
    print(f"ì‹œìŠ¤í…œ ë©”ëª¨ë¦¬: {memory_info['system_used'] / 1024**3:.1f}GB / {memory_info['system_total'] / 1024**3:.1f}GB")
    print(f"í”„ë¡œì„¸ìŠ¤ ë©”ëª¨ë¦¬: {memory_info['process_rss'] / 1024**2:.1f}MB")
    
    # ëª¨ë‹ˆí„°ë§ ì‹œì‘
    print("\në©”ëª¨ë¦¬ ëª¨ë‹ˆí„°ë§ ì‹œì‘ (5ì´ˆê°„)...")
    monitor.start_monitoring(interval=1.0)
    
    # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€ ì‹œë®¬ë ˆì´ì…˜
    print("ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€ ì‹œë®¬ë ˆì´ì…˜...")
    large_data = []
    for i in range(3):
        # í° ë°ì´í„° ìƒì„±
        large_data.append([0] * 1000000)  # ì•½ 8MB
        time.sleep(1)
        print(f"  ë°ì´í„° ë¸”ë¡ {i+1} ìƒì„±")
    
    time.sleep(2)
    
    # ë©”ëª¨ë¦¬ ì •ë¦¬
    print("ë©”ëª¨ë¦¬ ì •ë¦¬...")
    del large_data
    
    # ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ì‹¤í–‰
    collected = monitor.force_gc()
    print(f"ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ê²°ê³¼: {collected}")
    
    time.sleep(1)
    monitor.stop_monitoring()


def demo_integrated_performance():
    """í†µí•© ì„±ëŠ¥ ìµœì í™” ë°ëª¨"""
    print("\n=== í†µí•© ì„±ëŠ¥ ìµœì í™” ë°ëª¨ ===")
    
    optimizer = get_performance_optimizer()
    
    print("ì„±ëŠ¥ ìµœì í™”ê¸° ì´ˆê¸°í™” ì™„ë£Œ")
    
    # ì„±ëŠ¥ í†µê³„
    stats = optimizer.get_performance_stats()
    print(f"\nì´ˆê¸° ì„±ëŠ¥ í†µê³„:")
    print(f"  ê¸´ê¸‰ë„ ìºì‹œ: {stats['urgency_cache']['size']}/{stats['urgency_cache']['max_size']}")
    print(f"  ë°°ì¹˜ ëŒ€ê¸°: {stats['batch_pending']}ê°œ")
    print(f"  ì‹¤ì‹œê°„ í: {stats['realtime_queue']}ê°œ")
    print(f"  ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : {stats['memory_info']['usage_ratio']:.1%}")
    
    # ì‹œë®¬ë ˆì´ì…˜ëœ ì‘ì—… ë¶€í•˜
    print("\nì‘ì—… ë¶€í•˜ ì‹œë®¬ë ˆì´ì…˜...")
    
    # ê¸´ê¸‰ë„ ê³„ì‚° (ìºì‹±ë¨)
    test_dates = [datetime.now() + timedelta(hours=i) for i in range(10)]
    for due_date in test_dates:
        DateService.get_urgency_level(due_date)
    
    # ë°°ì¹˜ ì—…ë°ì´íŠ¸
    for i in range(8):
        optimizer.batch_manager.queue_update('test_update', i, {'data': f'test_{i}'})
    
    # ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
    for i in range(15):
        optimizer.realtime_optimizer.request_update('test_component')
    
    time.sleep(2)
    
    # ìµœì¢… í†µê³„
    final_stats = optimizer.get_performance_stats()
    print(f"\nìµœì¢… ì„±ëŠ¥ í†µê³„:")
    print(f"  ê¸´ê¸‰ë„ ìºì‹œ: {final_stats['urgency_cache']['size']}/{final_stats['urgency_cache']['max_size']}")
    print(f"  ë°°ì¹˜ ëŒ€ê¸°: {final_stats['batch_pending']}ê°œ")
    print(f"  ì‹¤ì‹œê°„ í: {final_stats['realtime_queue']}ê°œ")
    print(f"  ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : {final_stats['memory_info']['usage_ratio']:.1%}")
    
    optimizer.shutdown()


def main():
    """ë©”ì¸ ë°ëª¨ ì‹¤í–‰"""
    print("ì„±ëŠ¥ ìµœì í™” ë° ë©”ëª¨ë¦¬ ê´€ë¦¬ ê¸°ëŠ¥ ë°ëª¨")
    print("=" * 50)
    
    try:
        demo_urgency_cache()
        demo_batch_update()
        demo_realtime_update()
        demo_memory_monitor()
        demo_integrated_performance()
        
        print("\n" + "=" * 50)
        print("ëª¨ë“  ë°ëª¨ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! âœ…")
        
    except Exception as e:
        print(f"\nâŒ ë°ëª¨ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        import traceback
        traceback.print_exc()
        return 1
    
    return 0


if __name__ == "__main__":
    exit(main())